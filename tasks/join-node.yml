- name: Kubernetes | Generate Join Token
  command: kubeadm token generate
  register: join_tokens
  when: "'root_cluster' in group_names"
  with_items: "{{ groups['kube_workers'] }}"

- name: DEBUG
  debug:
    msg: "{{ item }}"
  with_dict: "{{ join_tokens.results }}"

- name: DEBUG
  debug:
    msg: "{{ item.value.stdout_lines[0] }}"
  with_dict: "{{ join_tokens.results }}"

- name: Kubernetes | Join Worker Node
  command: "kubeadm join {{ kubernetes.load_balancer.dns }}:{{ kubernetes.load_balancer.port }} --token {{ item.value.stdout_lines[0] }} --discovery-token-unsafe-skip-ca-verification"
  when: "'kube_workers' in group_names"
  with_items: "{{ join_tokens.results }}"
